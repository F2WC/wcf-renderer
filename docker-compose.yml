version: '3.9'

services:
  app-shell:
    image: node:24-alpine
    working_dir: /app/playground/shell
    # Wait until both MFEs produced their first build artifact, then start Vite dev server
    command: >-
      sh -lc "npm ci && \
      for i in $(seq 1 120); do \
        [ -f ../mfe-vue-one/dist/index.js ] && [ -f ../mfe-react-one/dist/index.js ] && break; \
        echo 'Waiting for MFEs to build...' && sleep 1; \
      done; \
      if [ ! -f ../mfe-vue-one/dist/index.js ] || [ ! -f ../mfe-react-one/dist/index.js ]; then \
        echo 'MFEs not built within timeout' >&2; exit 1; \
      fi; \
      npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - '5173:5173'
    environment:
      - NODE_ENV=development
    volumes:
      - ./:/app
    depends_on:
      mfe-vue-one:
        condition: service_healthy
      mfe-react-one:
        condition: service_healthy

  mfe-vue-one:
    image: node:24-alpine
    working_dir: /app/playground/mfe-vue-one
    command: sh -lc "mkdir -p ../../packages/sdk/dist && npm ci && npm run build-only -- --watch"
    environment:
      - NODE_ENV=development
    volumes:
      - ./:/app
    depends_on:
      sdk:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'test -f /app/playground/mfe-vue-one/dist/index.js']
      interval: 5s
      timeout: 2s
      retries: 60
      start_period: 20s

  mfe-react-one:
    image: node:24-alpine
    working_dir: /app/playground/mfe-react-one
    command: sh -lc "mkdir -p ../../packages/sdk/dist && npm ci && npm run build -- --watch"
    environment:
      - NODE_ENV=development
    volumes:
      - ./:/app
    depends_on:
      sdk:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'test -f /app/playground/mfe-react-one/dist/index.js']
      interval: 5s
      timeout: 2s
      retries: 60
      start_period: 20s

  sdk:
    image: node:24-alpine
    working_dir: /app/packages/sdk
    command: sh -lc "npm ci && npm run dev"
    environment:
      - NODE_ENV=development
    volumes:
      - ./:/app
    healthcheck:
      test: ['CMD-SHELL', 'test -f /app/packages/sdk/dist/index.js']
      interval: 5s
      timeout: 2s
      retries: 60
      start_period: 10s

  shell:
    image: node:24-alpine
    working_dir: /app/packages/shell
    command: sh -lc "npm ci && npm run dev"
    environment:
      - NODE_ENV=development
    volumes:
      - ./:/app
    healthcheck:
      test: ['CMD-SHELL', 'test -f /app/packages/shell/dist/index.js']
      interval: 5s
      timeout: 2s
      retries: 60
      start_period: 10s

  nginx:
    image: nginx:alpine3.22-slim
    volumes:
      - ./playground/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./playground/mfe-vue-one/dist:/usr/share/nginx/html/vue
      - ./playground/mfe-react-one/dist:/usr/share/nginx/html/react
      - ./playground/shell/dist:/usr/share/nginx/html/shell
    ports:
      - '8080:8080'
